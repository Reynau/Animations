<canvas id="gc" width="800" height="800"></canvas>
<script>

var vars = {
	divide_prob: 10,
	max_width: 6,
	max_depth: 80,
	min_length: 5,
	max_length: 25,
}

var nodes = [];

function create_node(x, y, depth, level) {
	return {
		x: x,
		y: y,
		depth: depth,
		level: level,
		childs: [],
	}
}

function generate_child(ox, oy, depth, level) {
	var angle = Math.PI / random(3, 5);
	var dir = random_round(0,1) ? -1 : 1;
	var length = random(vars.min_length, vars.max_length);

	var x = ox + Math.cos(angle) * length * dir;
	var y = oy + Math.sin(angle) * length;

	return create_node(x, y, depth, level);
}

function loop () {
	update();
	draw();
}

function update () {
	// Save childs in auxiliary array
	var new_nodes = [];
	for (var i = 0; i < nodes.length; ++i) {
		var node = nodes[i];
		for (var c = 0; c < node.childs.length; ++c) {
			new_nodes.push(node.childs[c]);
		}
	}

	// Copy childs to nodes array
	nodes = [];
	for (var i = 0; i < new_nodes.length; ++i) {
		nodes.push(new_nodes[i]);
	}

	// Generate new childs
	for (var i = 0; i < nodes.length; ++i) {
		var node = nodes[i];

		if (node.depth == vars.max_depth) continue;

		if (random_round(0,100) <= 100 - node.level * 15) 
			node.childs.push(generate_child(node.x, node.y, node.depth+1, node.level));
		if (random_round(0,100) <= vars.divide_prob) 
			node.childs.push(generate_child(node.x, node.y, node.depth+1, node.level+1));
	}	
}

function draw () {
	for (var i = 0; i < nodes.length; ++i) {
		var node = nodes[i];
		for (var c = 0; c < node.childs.length; ++c) {
			var child = node.childs[c];
			var w = vars.max_width - child.level * 3;
			if (w < 1) w = 1;
			draw_line(node.x, node.y, child.x, child.y, w);
		}
	}
}

function draw_line (ox, oy, dx, dy, w) {
	ctx.beginPath();
	ctx.moveTo(ox, oy);
	ctx.lineTo(dx, dy);
	ctx.lineWidth = w;
	ctx.strokeStyle = vars.tree_color;
	ctx.stroke();
}

window.onload = function () {
	canv = document.getElementById("gc");
	ctx = canv.getContext("2d");

	ctx.fillStyle = "white";
	ctx.fillRect(0, 0, canv.width, canv.height);

	var num_thunderbolts = random_round(1,3);
	var thundebolt_zone = canv.width / num_thunderbolts;

	var start_node;
	var child_node;
	for (var i = 0; i < num_thunderbolts; ++i) {
		var zone_init = i * thundebolt_zone;
		var zone_end = zone_init + thundebolt_zone;
		start_node = create_node(random(zone_init,zone_end), 100, 0, 0);
		child_node = generate_child(start_node.x, start_node.y, start_node.depth, start_node.level);
		start_node.childs.push(child_node);
		nodes.push(start_node);
		draw_line(start_node.x, start_node.y, child_node.x, child_node.y, vars.max_width);
	}

	setInterval(loop, 1000/300);
}

function random (min, max, round) {
  	return Math.random() * (max - min + 1) + min;
}

function random_round (min, max, round) {
  	return Math.floor(Math.random() * (max - min + 1)) + min;
}

function module (x, y) {
	return Math.sqrt(square(x) + square(y));
}

function distance (x1, y1, x2, y2) {
	return Math.sqrt(square(x1 - x2) + square(y1 - y2));
}

function square (x) {
	return x*x;
}

</script>
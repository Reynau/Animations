<canvas id="gc" width="800" height="800"></canvas>
<script type="text/javascript" src="dat.gui.min.js"></script>
<script>

var vars = {
	n_drops: 800,
	max_n_drops: 1500,
	background_color: "#002040",
	drop_color: "#79aeff",
	drop_speed: 15,
	drop_speed_diff: 5,
	drop_length: 9,
	drop_length_diff: 2,
	lightning_probability: 100,
	lightning_total_frames: 5,
	lightning_color: "#ffffd2",
	wind_probability: 80,
	wind_total_frames: 15,
	wind_force: 0,
	wind_max_speed: 20,
	wind_min_speed: 4,
	wind_speed: 10,
}

var drops = [];
var lightning = false;
var lightning_frames = 0;
var wind = false;
var wind_frames = 0;
var wind_sin = 0;
var wind_dir = 0;

var margin = 600;

function createDrop (w, h) {
	return {
		x: random(-margin, w + margin),
		y: Math.random() * h,
		px: this.x,
		py: this.y,
		yv: random(vars.drop_speed, vars.drop_speed + vars.drop_speed_diff),
		length: random(vars.drop_length, vars.drop_length_diff),
		update: function () {
			this.px = this.x;
			this.py = this.y;

			this.x += vars.wind_force;
			this.y += this.yv;
			
			if (this.y > h + this.length || this.x > w + margin || this.x < -margin) {
				this.yv = random(vars.drop_speed, vars.drop_speed + vars.drop_speed_diff),
				this.x = random(-margin, w + margin);
				this.y = 0 - this.yv;
				this.px = this.x;
				this.py = this.y;
			}
		},
		draw: function () {
			var dist = distance(this.px, this.py, this.x, this.y);
			var x = this.x - this.px;
			var y = this.y - this.py;

			var ux = x / module(x,y);
			var uy = y / module(x,y);

			// Draw drops
			ctx.beginPath();
			ctx.moveTo(this.x, this.y);
			ctx.lineTo(this.x + ux * this.length * 1.1, this.y + uy * this.length * 1.1);
			ctx.lineWidth = 2;
			ctx.strokeStyle = vars.drop_color;
			ctx.stroke();
		}
	}
}

function loop () {
	update();
	draw();
}

function update () {
	if (vars.wind_probability > 0 && wind) {
		wind_sin += (Math.PI / vars.wind_total_frames);
		if (wind_dir === 0) vars.wind_force = -(Math.sin(wind_sin) * vars.wind_speed);
		if (wind_dir === 1) vars.wind_force = Math.sin(wind_sin) * vars.wind_speed;
		++wind_frames;
		if (wind_frames === vars.wind_total_frames) {
			wind_sin = 0;
			vars.wind_force = 0;
			wind_frames = 0;
			wind = false;
		}
	}
	else if (vars.wind_probability > 0) {
		var wind_rand = random(1, vars.wind_probability);
		if (wind_rand === vars.wind_probability) {
			wind = true;
			wind_dir = random(0,1);
			vars.wind_speed = random(vars.wind_min_speed, vars.wind_max_speed);
			vars.wind_total_frames = vars.wind_speed * 3;
		}
	}

	if (vars.lightning_probability > 0 && lightning) {
		++lightning_frames;

		if (lightning_frames === vars.lightning_total_frames) {
			lightning_frames = 0;
			lightning = false;
		}
	}
	else if (vars.lightning_probability > 0) {
		var lightning_rand = random(1, vars.lightning_probability);
		if (lightning_rand === vars.lightning_probability) {
			lightning = true;
			vars.lightning_total_frames = random(3,5);
		}
	}

	for (var i = 0; i < vars.n_drops; ++i) {
		drops[i].update();
	}
}

function draw () {
	drawBackground();

	for (var i = 0; i < vars.n_drops; ++i) {
		drops[i].draw();
	}
}

function drawBackground () {
	var color;

	if (lightning) color = vars.lightning_color;
	else color = vars.background_color;

	ctx.fillStyle = color;
	ctx.fillRect(0, 0, canv.width, canv.height);
}


window.onload = function () {
	canv = document.getElementById("gc");
	ctx = canv.getContext("2d");

	var gui = new dat.GUI();
	gui.add(vars, 'n_drops', 0, vars.max_n_drops);
	gui.add(vars, 'background_color');
	gui.add(vars, 'drop_color');
	//gui.add(vars, 'drop_speed', 0, 50);
	//gui.add(vars, 'drop_speed_diff', 0, 25);
	//gui.add(vars, 'drop_length', 0, 20);
	//gui.add(vars, 'drop_length_diff', 0, 10);
	//gui.add(vars, 'lightning_probability', 0, 200);
	//gui.add(vars, 'lightning_total_frames', 0, 10);
	gui.add(vars, 'lightning_color');

	for (var i = 0; i < vars.max_n_drops; ++i) {
		drops[i] = createDrop(canv.width, canv.height);
	}

	setInterval(loop, 1000/30);
}

function random(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function module (x, y) {
	return Math.sqrt(square(x) + square(y));
}

function distance (x1, y1, x2, y2) {
	return Math.sqrt(square(x1 - x2) + square(y1 - y2));
}

function square (x) {
	return x*x;
}

</script>